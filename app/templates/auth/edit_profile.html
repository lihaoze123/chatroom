{% extends "base.html" %}

{% block title %}编辑个人资料 - 聊天室{% endblock %}

{% block head %}
<style>
    .edit-profile-container {
        max-width: 800px;
        margin: 0 auto;
    }
    
    .form-section {
        background: white;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }
    
    .section-title {
        color: #495057;
        font-weight: 600;
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e9ecef;
        display: flex;
        align-items: center;
    }
    
    .section-title i {
        margin-right: 0.5rem;
        color: #667eea;
    }
    
    .form-floating {
        margin-bottom: 1.5rem;
    }
    
    .form-floating input,
    .form-floating select,
    .form-floating textarea {
        border: 2px solid #e9ecef;
        border-radius: 10px;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.9);
    }
    
    .form-floating input:focus,
    .form-floating select:focus,
    .form-floating textarea:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        background: white;
    }
    
    .form-floating label {
        color: #6c757d;
        font-weight: 500;
    }
    
    .form-floating textarea {
        min-height: 120px;
        resize: vertical;
    }
    
    .avatar-upload {
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .current-avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        border: 4px solid #e9ecef;
        object-fit: cover;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }
    
    .current-avatar:hover {
        transform: scale(1.05);
        border-color: #667eea;
    }
    
    .upload-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 25px;
        padding: 0.5rem 1.5rem;
        color: white;
        font-weight: 500;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .upload-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }
    
    .btn-group-custom {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 2rem;
    }
    
    .btn-save {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: none;
        border-radius: 25px;
        padding: 0.75rem 2rem;
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-save:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        color: white;
    }
    
    .btn-cancel {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        border: none;
        border-radius: 25px;
        padding: 0.75rem 2rem;
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
    }
    
    .btn-cancel:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(108, 117, 125, 0.4);
        color: white;
    }
    
    .btn-reset {
        background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        border: none;
        border-radius: 25px;
        padding: 0.75rem 2rem;
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-reset:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(255, 193, 7, 0.4);
        color: white;
    }
    
    .required-field {
        position: relative;
    }
    
    .required-field::after {
        content: '*';
        color: #dc3545;
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        font-weight: bold;
    }
    
    .help-text {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
    
    .form-row {
        display: flex;
        gap: 1rem;
    }
    
    .form-row .form-floating {
        flex: 1;
    }
    
    @media (max-width: 768px) {
        .edit-profile-container {
            margin: 0 1rem;
        }
        
        .form-section {
            padding: 1.5rem;
        }
        
        .form-row {
            flex-direction: column;
            gap: 0;
        }
        
        .btn-group-custom {
            flex-direction: column;
            align-items: center;
        }
        
        .btn-group-custom button,
        .btn-group-custom a {
            width: 100%;
            max-width: 200px;
        }
    }
    
    .is-invalid {
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
    }
    
    .invalid-feedback {
        display: block;
        width: 100%;
        margin-top: 0.25rem;
        font-size: 0.875em;
        color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="edit-profile-container">
    <form method="POST" id="editProfileForm" enctype="multipart/form-data">
        <!-- 头像上传区域 -->
        <div class="form-section">
            <h4 class="section-title">
                <i class="fas fa-camera"></i>头像设置
            </h4>
            <div class="avatar-upload">
                <img src="{{ url_for('static', filename='images/avatars/' + (user.avatar or 'default.jpg')) }}" 
                     alt="当前头像" class="current-avatar" id="avatarPreview"
                     onerror="this.src='{{ url_for('static', filename='images/avatars/default.jpg') }}'">
                <div>
                    <input type="file" id="avatarInput" name="avatar" accept="image/*" style="display: none;">
                    <button type="button" class="upload-btn" onclick="document.getElementById('avatarInput').click()">
                        <i class="fas fa-upload"></i> 选择头像
                    </button>
                    <div class="help-text">支持 JPG、PNG 格式，建议尺寸 200x200 像素</div>
                </div>
            </div>
        </div>
        
        <!-- 基本信息 -->
        <div class="form-section">
            <h4 class="section-title">
                <i class="fas fa-user"></i>基本信息
            </h4>
            
            <div class="form-row">
                <div class="form-floating">
                    <input type="text" class="form-control" id="real_name" name="real_name" 
                           value="{{ user.real_name or '' }}" placeholder="真实姓名">
                    <label for="real_name">真实姓名</label>
                </div>
                
                <div class="form-floating">
                    <select class="form-select" id="gender" name="gender">
                        <option value="">请选择</option>
                        <option value="男" {{ 'selected' if user.gender == '男' }}>男</option>
                        <option value="女" {{ 'selected' if user.gender == '女' }}>女</option>
                        <option value="其他" {{ 'selected' if user.gender == '其他' }}>其他</option>
                    </select>
                    <label for="gender">性别</label>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-floating">
                    <input type="date" class="form-control" id="birthday" name="birthday" 
                           value="{{ user.birthday.strftime('%Y-%m-%d') if user.birthday else '' }}">
                    <label for="birthday">生日</label>
                </div>
                
                <div class="form-floating">
                    <input type="text" class="form-control" id="occupation" name="occupation" 
                           value="{{ user.occupation or '' }}" placeholder="职业">
                    <label for="occupation">职业</label>
                </div>
            </div>
        </div>
        
        <!-- 联系方式 -->
        <div class="form-section">
            <h4 class="section-title">
                <i class="fas fa-address-book"></i>联系方式
            </h4>
            
            <div class="form-floating">
                <input type="tel" class="form-control" id="phone" name="phone" 
                       value="{{ user.phone or '' }}" placeholder="电话号码">
                <label for="phone">电话号码</label>
                <div class="help-text">格式：+86 138-0013-8000 或 138-0013-8000</div>
            </div>
            
            <div class="form-floating">
                <input type="text" class="form-control" id="address" name="address" 
                       value="{{ user.address or '' }}" placeholder="地址">
                <label for="address">地址</label>
            </div>
            
            <div class="form-floating">
                <input type="url" class="form-control" id="website" name="website" 
                       value="{{ user.website or '' }}" placeholder="个人网站">
                <label for="website">个人网站</label>
                <div class="help-text">格式：https://www.example.com</div>
            </div>
        </div>
        
        <!-- 个人简介 -->
        <div class="form-section">
            <h4 class="section-title">
                <i class="fas fa-quote-left"></i>个人简介
            </h4>
            
            <div class="form-floating">
                <textarea class="form-control" id="bio" name="bio" placeholder="个人简介" 
                          style="height: 120px;">{{ user.bio or '' }}</textarea>
                <label for="bio">个人简介</label>
                <div class="help-text">最多 500 字符，介绍一下你自己吧</div>
            </div>
        </div>
        
        <!-- 操作按钮 -->
        <div class="btn-group-custom">
            <button type="submit" class="btn btn-save">
                <i class="fas fa-save"></i> 保存更改
            </button>
            <button type="reset" class="btn btn-reset">
                <i class="fas fa-undo"></i> 重置
            </button>
            <a href="{{ url_for('auth.profile') }}" class="btn-cancel">
                <i class="fas fa-times"></i> 取消
            </a>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script src="https://kit.fontawesome.com/your-fontawesome-kit.js" crossorigin="anonymous"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 头像预览功能
    const avatarInput = document.getElementById('avatarInput');
    const avatarPreview = document.getElementById('avatarPreview');
    
    avatarInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // 验证文件类型
            if (!file.type.startsWith('image/')) {
                alert('请选择图片文件！');
                return;
            }
            
            // 验证文件大小（限制为2MB）
            if (file.size > 2 * 1024 * 1024) {
                alert('图片大小不能超过2MB！');
                return;
            }
            
            // 预览图片
            const reader = new FileReader();
            reader.onload = function(e) {
                avatarPreview.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    });
    
    // 表单验证
    const form = document.getElementById('editProfileForm');
    form.addEventListener('submit', function(e) {
        let isValid = true;
        
        // 清除之前的错误状态
        const inputs = form.querySelectorAll('.form-control, .form-select');
        inputs.forEach(input => {
            input.classList.remove('is-invalid');
            const feedback = input.parentNode.querySelector('.invalid-feedback');
            if (feedback) {
                feedback.remove();
            }
        });
        
        // 验证电话号码格式
        const phone = document.getElementById('phone');
        if (phone.value.trim()) {
            const phoneRegex = /^(\+86\s?)?1[3-9]\d{9}$|^(\+86\s?)?\d{3,4}-\d{7,8}$/;
            if (!phoneRegex.test(phone.value.trim())) {
                showFieldError(phone, '电话号码格式不正确');
                isValid = false;
            }
        }
        
        // 验证网站URL格式
        const website = document.getElementById('website');
        if (website.value.trim()) {
            try {
                new URL(website.value.trim());
            } catch {
                showFieldError(website, '网站地址格式不正确');
                isValid = false;
            }
        }
        
        // 验证个人简介长度
        const bio = document.getElementById('bio');
        if (bio.value.length > 500) {
            showFieldError(bio, '个人简介不能超过500字符');
            isValid = false;
        }
        
        if (!isValid) {
            e.preventDefault();
        }
    });
    
    // 显示字段错误
    function showFieldError(field, message) {
        field.classList.add('is-invalid');
        const feedback = document.createElement('div');
        feedback.className = 'invalid-feedback';
        feedback.textContent = message;
        field.parentNode.appendChild(feedback);
    }
    
    // 实时字符计数
    const bio = document.getElementById('bio');
    const bioContainer = bio.parentNode;
    const helpText = bioContainer.querySelector('.help-text');
    
    bio.addEventListener('input', function() {
        const remaining = 500 - this.value.length;
        helpText.textContent = `最多 500 字符，还可输入 ${remaining} 字符`;
        
        if (remaining < 0) {
            helpText.style.color = '#dc3545';
            this.classList.add('is-invalid');
        } else {
            helpText.style.color = '#6c757d';
            this.classList.remove('is-invalid');
        }
    });
    
    // 重置按钮功能
    const resetBtn = document.querySelector('.btn-reset');
    resetBtn.addEventListener('click', function(e) {
        e.preventDefault();
        if (confirm('确定要重置所有更改吗？')) {
            form.reset();
            // 重置头像预览
            avatarPreview.src = "{{ url_for('static', filename='images/avatars/' + (user.avatar or 'default.jpg')) }}";
            // 清除错误状态
            const inputs = form.querySelectorAll('.form-control, .form-select');
            inputs.forEach(input => {
                input.classList.remove('is-invalid');
                const feedback = input.parentNode.querySelector('.invalid-feedback');
                if (feedback) {
                    feedback.remove();
                }
            });
        }
    });
});
</script>
{% endblock %}